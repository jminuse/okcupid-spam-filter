<html>
<head>
	<title>OkCupid Spam Filter</title>
</head>
<body>
<script>

function get_string_between(string,a,b){
	var start = string.indexOf(a);
	var end = string.indexOf(b, start);
	return string.slice(a,b);
}

function http_request(url, params, data) {
	var xmlHttp = new XMLHttpRequest();
	if(params) {
		var param_string = [];
		for(key in params) {
			param_string.append(key+'='+params[key]);
		}
		url = '?' + param_string.join('&');
	}
	if(data) {
		var data_string = [];
		for(key in data) {
			data_string.append(key+'='+data[key]);
		}
		data_string = data_string.join('&');
		
		http.setRequestHeader("Content-type", "application/x-www-form-urlencoded");
		http.setRequestHeader("Content-length", data_string.length);
		http.setRequestHeader("Connection", "close");
		
		xmlHttp.open( "POST", url, false );
		xmlHttp.send(data_string);
	}
	else {
		xmlHttp.open( "GET", url, false );
		xmlHttp.send(null);
	}
	return xmlHttp.responseText;
}

function delete_thread(session, content, thread_params) {
	var form = get_string_between(content, 'id="delete_button"', '</form>');
	var form_data = {'deletethread':'DELETE'};
	var start = 0;
	while(start<form.length) {
		var m.slice(start) = form.match( /type="hidden" name="([^"]+)" (?:id="[^"]+" )?value="([^"]+)"/ );
		form_data[ m[1] ] = m[2];
		start = m.index + m[0].length;
	}
	http_request('http://www.okcupid.com/mailbox', thread_params, form_data);
}

def login(username, password) {
	session = requests.Session()
	credentials = {'username': username, 'password': password, 'dest': '/home'}
	login_response = session.post('https://www.okcupid.com/login', data=credentials)
	return session
}

</script>
</body>
</html>


def score_message(message_original):
	bad_strings = ['oriental', 'exotic']
	good_strings = []
	message = message_original.lower()
	score = 0
	for string in bad_strings:
		if string in message: score -= 10
	for string in good_strings:
		if string in message: score += 10
	return score

username = 'fill this in'
password = 'fill this in too'
if username == 'fill this in':
	print 'Fill in your username and password!'
	sys.exit(1)
session = login(username, password)

time.sleep(1+random.random())
messages_response = session.get('http://www.okcupid.com/messages')
thread_ids = re.findall('threadid="([^"]+)"', messages_response.content)

for thread in thread_ids:
	thread_data = {'readmsg': 'true', 'threadid': thread, 'folder': 1}
	time.sleep(1+random.random())
	get_thread = session.get('http://www.okcupid.com/messages', params=thread_data)
	message = get_string_between(get_thread.content, '<div class="message_body">', '</div>')

	if score_message(message) < 0:
		print 'Deleting "%s"' % message
		time.sleep(1+random.random())
		delete_thread(session, get_thread.content)

